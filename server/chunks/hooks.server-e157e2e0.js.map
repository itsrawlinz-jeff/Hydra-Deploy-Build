{"version":3,"file":"hooks.server-e157e2e0.js","sources":["../../../.svelte-kit/adapter-node/chunks/hooks.server.js"],"sourcesContent":["import { C as COOKIE_NAME } from \"./private.js\";\nimport { f as PUBLIC_APP_DISCLAIMER, g as PUBLIC_GOOGLE_ANALYTICS_ID } from \"./public.js\";\nimport { c as collections } from \"./database.js\";\nimport { b as base } from \"./paths.js\";\nimport { r as requiresUser, b as refreshSessionCookie } from \"./auth.js\";\nimport { E as ERROR_MESSAGES } from \"./errors.js\";\nconst handle = async ({ event, resolve }) => {\n  const token = event.cookies.get(COOKIE_NAME);\n  event.locals.sessionId = token || crypto.randomUUID();\n  const user = await collections.users.findOne({ sessionId: event.locals.sessionId });\n  if (user) {\n    event.locals.user = user;\n  }\n  function errorResponse(status, message) {\n    const sendJson = event.request.headers.get(\"accept\")?.includes(\"application/json\") || event.request.headers.get(\"content-type\")?.includes(\"application/json\");\n    return new Response(sendJson ? JSON.stringify({ error: message }) : message, {\n      status,\n      headers: {\n        \"content-type\": sendJson ? \"application/json\" : \"text/plain\"\n      }\n    });\n  }\n  const requestContentType = event.request.headers.get(\"content-type\")?.split(\";\")[0] ?? \"\";\n  const nativeFormContentTypes = [\n    \"multipart/form-data\",\n    \"application/x-www-form-urlencoded\",\n    \"text/plain\"\n  ];\n  if (event.request.method === \"POST\" && nativeFormContentTypes.includes(requestContentType)) {\n    const referer = event.request.headers.get(\"referer\");\n    if (!referer) {\n      return errorResponse(403, \"Non-JSON form requests need to have a referer\");\n    }\n    const validOrigins = [\n      new URL(event.request.url).origin,\n      ...[]\n    ];\n    if (!validOrigins.includes(new URL(referer).origin)) {\n      return errorResponse(403, \"Invalid referer for POST request\");\n    }\n  }\n  if (!event.url.pathname.startsWith(`${base}/login`) && !event.url.pathname.startsWith(`${base}/admin`) && ![\"GET\", \"OPTIONS\", \"HEAD\"].includes(event.request.method)) {\n    if (!user && requiresUser && !(0 > 0)) {\n      return errorResponse(401, ERROR_MESSAGES.authOnly);\n    }\n    if (!requiresUser && !event.url.pathname.startsWith(`${base}/settings`) && !!PUBLIC_APP_DISCLAIMER) {\n      const hasAcceptedEthicsModal = await collections.settings.countDocuments({\n        sessionId: event.locals.sessionId,\n        ethicsModalAcceptedAt: { $exists: true }\n      });\n      if (!hasAcceptedEthicsModal) {\n        return errorResponse(405, \"You need to accept the welcome modal first\");\n      }\n    }\n  }\n  refreshSessionCookie(event.cookies, event.locals.sessionId);\n  let replaced = false;\n  const response = await resolve(event, {\n    transformPageChunk: (chunk) => {\n      if (replaced || !chunk.html.includes(\"%gaId%\")) {\n        return chunk.html;\n      }\n      replaced = true;\n      return chunk.html.replace(\"%gaId%\", PUBLIC_GOOGLE_ANALYTICS_ID);\n    }\n  });\n  return response;\n};\nexport {\n  handle\n};\n"],"names":[],"mappings":"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"}